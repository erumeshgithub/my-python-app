name: Linux Python to APK Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux-apk:
    name: Build APK on Linux Runner
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Linux filesystem checkout
    - name: Checkout code (Linux)
      uses: actions/checkout@v4

    # Step 2: Linux Python setup
    - name: Setup Python 3.9 on Linux
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # Step 3: Linux system dependencies
    - name: Install Linux build dependencies
      run: |
        echo "Current Linux distribution:"
        lsb_release -a
        
        echo "Installing Ubuntu/Debian specific packages..."
        sudo apt-get update
        
        # Ubuntu-specific package names
        sudo apt-get install -y \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-dev \
          python3-venv \
          python3-pip

    # Step 4: Linux Python environment
    - name: Setup Linux Python environment
      run: |
        echo "Upgrading Linux pip..."
        python -m pip install --upgrade pip setuptools wheel
        
        echo "Installing Linux-compatible versions..."
        pip install buildozer
        pip install "cython==0.29.33"
        
        echo "Python packages installed:"
        pip list

    # Step 5: Linux APK build
    - name: Build APK on Linux
      run: |
        echo "Starting Linux APK build process..."
        echo "Working directory: $(pwd)"
        echo "Linux user: $(whoami)"
        
        # Linux-specific build command
        buildozer -v android debug

    # Step 6: Upload APK from Linux filesystem
    - name: Upload APK from Linux
      uses: actions/upload-artifact@v4
      with:
        name: linux-apk
        path: bin/*.apk
        retention-days: 30

    # Step 7: Linux build summary
    - name: Linux build summary
      run: |
        echo "=== LINUX BUILD SUMMARY ==="
        echo "Linux Runner: $RUNNER_OS"
        echo "Repository: $GITHUB_REPOSITORY"
        echo "APK files generated:"
        ls -la bin/*.apk 2>/dev/null || echo "No APK files found"
        echo "=========================="
